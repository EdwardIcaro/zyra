<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYRA Admin | Complete Dashboard</title>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root { 
        --bg: #0f0f0f; 
        --card: #1a1a1a; 
        --border: #333; 
        --accent: #007bff; 
        --text: #e0e0e0;  /* ‚úÖ NOVO: texto claro global */
        --text-muted: #999;  /* ‚úÖ NOVO: texto secund√°rio */
    }
    body { 
        background: var(--bg); 
        color: var(--text);  /* ‚úÖ MUDADO: era #e0e0e0 */
        font-family: 'Segoe UI', sans-serif; 
    }
    .navbar { 
        background: var(--card); 
        border-bottom: 1px solid var(--border); 
    }
    .nav-tabs { 
        border-bottom: 2px solid var(--border); 
    }
    .nav-link { 
        color: var(--text-muted);  /* ‚úÖ MUDADO */
        border: none !important; 
        margin-right: 10px; 
        transition: 0.3s; 
    }
    .nav-link:hover { 
        color: var(--text);  /* ‚úÖ MUDADO */
    }
    .nav-link.active { 
        color: var(--accent) !important; 
        background: transparent !important; 
        border-bottom: 2px solid var(--accent) !important; 
        font-weight: bold; 
    }
    .card { 
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: 8px; 
    }
    .timeline { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding: 15px; 
        background: #252525; 
        border-radius: 8px; 
        min-height: 100px; 
    }
    .timeline-item { 
        background: #333; 
        border: 2px solid #555; 
        border-radius: 8px; 
        padding: 10px; 
        min-width: 120px; 
        cursor: move;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        color: var(--text);  /* ‚úÖ NOVO */
    }
    .timeline-item.active { 
        border-color: var(--accent); 
        background: #444; 
    }
    .preview-container { 
        background: #222; 
        border-radius: 8px; 
        padding: 20px; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 400px; 
    }
    
    /* ‚úÖ NOVOS estilos para labels e controles */
    label {
        color: var(--text);
        font-weight: 500;
    }
    
    .form-control, .form-select {
        background: #2a2a2a;
        border: 1px solid var(--border);
        color: var(--text);
    }
    
    .form-control:focus, .form-select:focus {
        background: #333;
        border-color: var(--accent);
        color: var(--text);
    }
    
    .text-muted {
        color: var(--text-muted) !important;
    }
</style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è ZYRA Admin Panel</span>
        <button class="btn btn-success btn-sm" onclick="applyChanges()">üîÑ Aplicar Mudan√ßas</button>
    </div>
</nav>

<div class="container-fluid px-4">
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link active" onclick="switchTab('items')">üì¶ Items</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" onclick="switchTab('monsters')">üëæ Monstros</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" onclick="switchTab('visual')">üé® Visual System</button>
        </li>
    </ul>

    <!-- ==================== ITEMS TAB ==================== -->
    <div id="itemsSection">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4">
                    <h5 class="text-primary mb-3">Editor de Item</h5>
                    <form id="itemForm">
                        <label>ID do Item</label>
                        <input type="text" id="i_id" class="form-control mb-2" required>
                        <label>Nome</label>
                        <input type="text" id="i_name" class="form-control mb-2" required>
                        <label>Tipo</label>
                        <select id="i_type" class="form-select mb-2">
                            <option value="material">Material</option>
                            <option value="weapon">Weapon</option>
                            <option value="armor">Armor</option>
                        </select>
                        <label>Grade</label>
                        <select id="i_grade" class="form-select mb-2">
                            <option value="">Nenhuma</option>
                            <option value="C">C</option>
                            <option value="B">B</option>
                            <option value="A">A</option>
                            <option value="S">S</option>
                        </select>
                        <label>Descri√ß√£o</label>
                        <textarea id="i_desc" class="form-control mb-3" rows="3"></textarea>
                        <button type="submit" class="btn btn-primary w-100">Salvar Item</button>
                    </form>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>ID</th><th>Nome</th><th>Tipo</th><th>Grade</th></tr>
                        </thead>
                        <tbody id="itemsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="visualSection" style="display: none;">
    <div class="row">
        <div class="col-md-4">
            
            <!-- ‚úÖ NOVO: Seletor de Modo -->
            <div class="card p-4 mb-3">
                <h5 class="text-warning mb-3">üéØ Modo de Configura√ß√£o</h5>
                <label>Configurar para:</label>
                <select id="visualModeSelect" class="form-select mb-2" onchange="switchVisualMode()">
                    <option value="global">Config Global (Todos os Players)</option>
                    <option value="item">Item Espec√≠fico</option>
                </select>
                
                <!-- Container que aparece quando item for selecionado -->
                <div id="itemSelectorContainer" style="display: none;">
                    <label>Selecionar Item:</label>
                    <select id="visualItemSelect" class="form-select mb-2" onchange="loadItemVisualConfig()">
                        <option value="">Carregando...</option>
                    </select>
                    <small class="text-muted">Camadas ser√£o salvas para este item espec√≠fico</small>
                </div>
            </div>

    <!-- ==================== MONSTERS TAB ==================== -->
    <div id="monstersSection" style="display: none;">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4">
                    <h5 class="text-warning mb-3">Editor de Monstro</h5>
                    <form id="monsterForm">
                        <label>ID</label>
                        <input type="text" id="m_id" class="form-control mb-2" required>
                        <label>Nome</label>
                        <input type="text" id="m_name" class="form-control mb-2" required>
                        <label>N√≠vel</label>
                        <input type="number" id="m_level" class="form-control mb-2" value="1">
                        <label>HP</label>
                        <input type="number" id="m_hp" class="form-control mb-2" value="50">
                        <label>Dano</label>
                        <input type="number" id="m_damage" class="form-control mb-2" value="5">
                        <label>Exp Base</label>
                        <input type="number" id="m_exp" class="form-control mb-3" value="10">
                        <button type="submit" class="btn btn-warning w-100">Salvar Monstro</button>
                    </form>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>ID</th><th>Nome</th><th>N√≠vel</th><th>HP</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="monstersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



    <!-- ==================== VISUAL SYSTEM TAB ==================== -->
    <div id="visualSection" style="display: none;">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4 mb-3">
                    <h5 class="text-info mb-3">üì¶ Adicionar Camada</h5>
                    <label>Tipo</label>
                    <select id="layerTypeSelect" class="form-select mb-2" onchange="loadAssetsForLayer()">
                        <option value="">Selecione...</option>
                        <option value="bodies">Corpos</option>
                        <option value="faces">Olhos</option>
                        <option value="hats">Chap√©us</option>
                    </select>
                    <label>Asset</label>
                    <select id="assetSelect" class="form-select mb-3" disabled></select>
                    <button class="btn btn-primary w-100" onclick="addLayerToTimeline()">‚ûï Adicionar</button>
                </div>

                <div class="card p-4">
                    <h5 class="text-warning mb-3">‚öôÔ∏è Ajustes da Camada</h5>
                    <div id="layerControls">
                        <p class="text-muted">Selecione uma camada</p>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3 mb-3">
                    <h5>üé¨ Timeline de Camadas</h5>
                    <div id="timeline" class="timeline">
                        <div class="text-muted" style="margin: auto;">Arraste assets aqui</div>
                    </div>
                </div>

                <div class="card p-0">
                    <div class="preview-container">
                        <div id="pixi-preview"></div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-success" onclick="saveGlobalConfig()">üíæ Salvar Config Global</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "http://localhost:2567";
const CLIENT_URL = "http://localhost:3000";

let pixiApp = null;
let previewContainer = null;
let layers = [];
let selectedLayerIndex = -1;
let layerSprites = new Map();

// ============================================
// TAB SWITCHING
// ============================================
function switchTab(tab) {
    document.querySelectorAll('[id$="Section"]').forEach(s => s.style.display = 'none');
    document.getElementById(tab + 'Section').style.display = 'block';
    
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    if (tab === 'items') loadItems();
    if (tab === 'monsters') loadMonsters();
    if (tab === 'visual') initPixi();
}

// ============================================
// ITEMS LOGIC
// ============================================
async function loadItems() {
    const res = await fetch(`${API_URL}/api/admin/items`);
    const data = await res.json();
    document.getElementById('itemsTableBody').innerHTML = data.map(i => `
        <tr onclick="editItem('${i.id}')">
            <td>${i.id}</td><td>${i.name}</td><td>${i.type}</td><td>${i.grade || '-'}</td>
        </tr>
    `).join('');
    window.cachedItems = data;
}

document.getElementById('itemForm').onsubmit = async (e) => {
    e.preventDefault();
    await fetch(`${API_URL}/api/admin/items/save`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id: document.getElementById('i_id').value,
            name: document.getElementById('i_name').value,
            description: document.getElementById('i_desc').value,
            type: document.getElementById('i_type').value,
            grade: document.getElementById('i_grade').value,
            stackable: document.getElementById('i_type').value === 'material'
        })
    });
    alert('Item salvo!');
    loadItems();
};

function editItem(id) {
    const i = window.cachedItems.find(x => x.id === id);
    if(!i) return;
    document.getElementById('i_id').value = i.id;
    document.getElementById('i_name').value = i.name;
    document.getElementById('i_desc').value = i.description || '';
    document.getElementById('i_type').value = i.type;
    document.getElementById('i_grade').value = i.grade || '';
}

// ============================================
// MONSTERS LOGIC
// ============================================
async function loadMonsters() {
    const res = await fetch(`${API_URL}/api/admin/monsters`);
    const data = await res.json();
    document.getElementById('monstersTableBody').innerHTML = data.map(m => `
        <tr onclick="editMonster('${m.id}')">
            <td>${m.id}</td><td>${m.name}</td><td>${m.level}</td><td>${m.stats?.maxHp || 50}</td>
            <td><button class="btn btn-sm btn-warning">Editar</button></td>
        </tr>
    `).join('');
    window.cachedMonsters = data;
}

document.getElementById('monsterForm').onsubmit = async (e) => {
    e.preventDefault();
    await fetch(`${API_URL}/api/admin/monsters/save`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id: document.getElementById('m_id').value,
            name: document.getElementById('m_name').value,
            level: parseInt(document.getElementById('m_level').value),
            stats: { 
                maxHp: parseInt(document.getElementById('m_hp').value),
                damage: parseInt(document.getElementById('m_damage').value)
            },
            rewards: { baseExp: parseInt(document.getElementById('m_exp').value) }
        })
    });
    alert('Monstro salvo!');
    loadMonsters();
};

function editMonster(id) {
    const m = window.cachedMonsters.find(x => x.id === id);
    if(!m) return;
    document.getElementById('m_id').value = m.id;
    document.getElementById('m_name').value = m.name;
    document.getElementById('m_level').value = m.level;
    document.getElementById('m_hp').value = m.stats?.maxHp || 50;
    document.getElementById('m_damage').value = m.stats?.damage || 5;
    document.getElementById('m_exp').value = m.rewards?.baseExp || 10;
}

async function applyChanges() {
    const res = await fetch(`${API_URL}/api/admin/reload`, { method: 'POST' });
    if(res.ok) alert('üöÄ Servidor sincronizado!');
}

let currentVisualMode = 'global';  // ‚úÖ NOVO: rastreia modo atual
let currentItemId = null;  // ‚úÖ NOVO: item selecionado
let baseBallSprite = null;  // ‚úÖ NOVO: refer√™ncia ao sprite base

// ‚úÖ NOVO: Alternar entre Global e Item
async function switchVisualMode() {
    currentVisualMode = document.getElementById('visualModeSelect').value;
    const itemContainer = document.getElementById('itemSelectorContainer');
    
    if (currentVisualMode === 'item') {
        itemContainer.style.display = 'block';
        await loadItemsForVisualConfig();
    } else {
        itemContainer.style.display = 'none';
        currentItemId = null;
        layers = [];
        renderTimeline();
        await renderPreview();
    }
    
    updateSaveButtonText();
}

// ‚úÖ NOVO: Carregar lista de itens
async function loadItemsForVisualConfig() {
    try {
        const res = await fetch(`${API_URL}/api/admin/items`);
        const items = await res.json();
        
        const select = document.getElementById('visualItemSelect');
        select.innerHTML = '<option value="">-- Selecione um Item --</option>' + 
            items.map(item => `<option value="${item.id}">${item.name} (${item.id})</option>`).join('');
    } catch (e) {
        console.error('[Visual] Erro ao carregar itens:', e);
    }
}

// ‚úÖ NOVO: Carregar config de um item
async function loadItemVisualConfig() {
    currentItemId = document.getElementById('visualItemSelect').value;
    
    if (!currentItemId) {
        layers = [];
        renderTimeline();
        await renderPreview();
        return;
    }
    
    try {
        const res = await fetch(`${API_URL}/api/admin/visual/item/${currentItemId}`);
        if (res.ok) {
            const data = await res.json();
            layers = data.layers || [];
            renderTimeline();
            await renderPreview();
        }
    } catch (e) {
        console.error('[Visual] Erro ao carregar config do item:', e);
        layers = [];
        renderTimeline();
        await renderPreview();
    }
}

// ‚úÖ NOVO: Atualizar texto do bot√£o
function updateSaveButtonText() {
    const btn = document.querySelector('button[onclick="saveGlobalConfig()"]');
    if (!btn) return;
    
    if (currentVisualMode === 'item' && currentItemId) {
        const itemName = document.getElementById('visualItemSelect').selectedOptions[0]?.text || 'Item';
        btn.textContent = `üíæ Salvar Config para ${itemName}`;
    } else {
        btn.textContent = 'üíæ Salvar Config Global';
    }
}

// ============================================
// VISUAL SYSTEM LOGIC
// ============================================
async function initPixi() {
    if (pixiApp) return;

    pixiApp = new PIXI.Application();
    await pixiApp.init({ width: 300, height: 300, backgroundColor: 0x222222 });
    
    document.getElementById('pixi-preview').innerHTML = '';
    document.getElementById('pixi-preview').appendChild(pixiApp.canvas);

    previewContainer = new PIXI.Container();
    previewContainer.x = 150;
    previewContainer.y = 150;
    pixiApp.stage.addChild(previewContainer);

    // ‚úÖ NOVO: Carregar bolinha base automaticamente
    await loadBaseBall();

    const highlight = new PIXI.Graphics();
    highlight.circle(0, 0, 30);
    highlight.stroke({ width: 2, color: 0xffff00, alpha: 0.5 });
    previewContainer.addChild(highlight);

    pixiApp.ticker.add(() => {
        const bounce = Math.sin(Date.now() / 200) * 0.04;
        previewContainer.scale.set(1 + bounce);
    });
}

// ‚úÖ NOVA FUN√á√ÉO: Carregar sprite base do corpo
async function loadBaseBall() {
    try {
        const path = `${CLIENT_URL}/assets/sprites/bodies/ball_red.png`;
        const texture = await PIXI.Assets.load(path);
        
        baseBallSprite = new PIXI.Sprite(texture);
        baseBallSprite.anchor.set(0.5);
        baseBallSprite.scale.set(1.0);  // Escala fixa
        baseBallSprite.zIndex = 0;  // Sempre na camada mais baixa
        
        previewContainer.addChild(baseBallSprite);
        previewContainer.sortChildren();
        
        console.log('[Visual] Bolinha base carregada automaticamente');
    } catch (e) {
        console.error('[Visual] Erro ao carregar bolinha:', e);
    }
}

async function loadAssetsForLayer() {
    const type = document.getElementById('layerTypeSelect').value;
    const select = document.getElementById('assetSelect');
    
    if (!type) {
        select.disabled = true;
        return;
    }

    try {
        const res = await fetch(`${API_URL}/api/admin/assets/${type}`);
        const files = await res.json();
        select.innerHTML = files.map(f => `<option value="${f.replace('.png', '')}">${f}</option>`).join('');
        select.disabled = false;
    } catch (e) {
        console.error(e);
    }
}

function addLayerToTimeline() {
    const type = document.getElementById('layerTypeSelect').value;
    const asset = document.getElementById('assetSelect').value;
    
    if (!type || !asset) {
        alert('Selecione tipo e asset!');
        return;
    }

    const defaults = {
        bodies: { offsetX: 0, offsetY: 0, scale: 1.0, rotation: 0, width: 58, height: 58 },
        faces: { offsetX: 0, offsetY: 5, scale: 1.0, rotation: 0, width: 35, height: 18 },
        hats: { offsetX: 0, offsetY: -20, scale: 1.0, rotation: 0, width: 60, height: 45 }
    };

    layers.push({
        type,
        asset,
        ...defaults[type],
        zIndex: layers.length
    });

    renderTimeline();
    renderPreview();
}

function renderTimeline() {
    const timeline = document.getElementById('timeline');
    
    if (layers.length === 0) {
        timeline.innerHTML = '<div class="text-muted" style="margin: auto;">Arraste assets aqui</div>';
        return;
    }

    timeline.innerHTML = layers.map((layer, idx) => `
        <div class="timeline-item ${idx === selectedLayerIndex ? 'active' : ''}" 
             onclick="selectLayer(${idx})">
            <div>${layer.asset}</div>
            <button class="btn btn-sm btn-danger" onclick="removeLayer(${idx}); event.stopPropagation();">üóëÔ∏è</button>
        </div>
    `).join('');
}

function selectLayer(index) {
    selectedLayerIndex = index;
    renderTimeline();
    showLayerControls(layers[index]);
}

function removeLayer(index) {
    layers.splice(index, 1);
    selectedLayerIndex = -1;
    renderTimeline();
    renderPreview();
    document.getElementById('layerControls').innerHTML = '<p class="text-muted">Selecione uma camada</p>';
}

function showLayerControls(layer) {
    const controls = document.getElementById('layerControls');
    
    controls.innerHTML = `
        <strong>${layer.asset}</strong>

        <label>Offset X: <span id="val_offsetX">${layer.offsetX}</span></label>
        <input type="range" class="form-range" id="range_offsetX" min="-100" max="100" value="${layer.offsetX}" oninput="updateLayerProp('offsetX', this.value)">

        <label>Offset Y: <span id="val_offsetY">${layer.offsetY}</span></label>
        <input type="range" class="form-range" id="range_offsetY" min="-100" max="100" value="${layer.offsetY}" oninput="updateLayerProp('offsetY', this.value)">

        <label>Escala: <span id="val_scale">${layer.scale.toFixed(2)}</span></label>
        <input type="range" class="form-range" id="range_scale" min="0.1" max="3.0" step="0.05" value="${layer.scale}" oninput="updateLayerProp('scale', this.value)">

        <label>Rota√ß√£o: <span id="val_rotation">${layer.rotation}¬∞</span></label>
        <input type="range" class="form-range" id="range_rotation" min="-180" max="180" step="5" value="${layer.rotation}" oninput="updateLayerProp('rotation', this.value)">
    `;
}

function updateLayerProp(prop, value) {
    if (selectedLayerIndex === -1) return;

    const numValue = parseFloat(value);
    layers[selectedLayerIndex][prop] = numValue;

    const displayElement = document.getElementById(`val_${prop}`);
    if (displayElement) {
        displayElement.innerText = prop === 'scale' ? numValue.toFixed(2) : Math.round(numValue);
    }
    
    renderPreview();
}

async function renderPreview() {
    if (!pixiApp || !previewContainer) await initPixi();

    // ‚úÖ MUDADO: Remover apenas sprites de camadas, n√£o a bolinha base
    layerSprites.forEach(sprite => {
        if (sprite !== baseBallSprite) {  // Preservar bolinha
            previewContainer.removeChild(sprite);
            sprite.destroy();
        }
    });
    layerSprites.clear();
    
    // ‚úÖ NOVO: Re-adicionar bolinha se foi removida acidentalmente
    if (baseBallSprite && !previewContainer.children.includes(baseBallSprite)) {
        previewContainer.addChildAt(baseBallSprite, 0);
    }

    for (let i = 0; i < layers.length; i++) {
        const layer = layers[i];
        const path = `${CLIENT_URL}/assets/sprites/${layer.type}/${layer.asset}.png`;

        try {
            const texture = await PIXI.Assets.load(path);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = layer.offsetX;
            sprite.y = layer.offsetY;
            sprite.scale.set(layer.scale);
            sprite.rotation = (layer.rotation * Math.PI) / 180;
            sprite.zIndex = i + 1;  // ‚úÖ MUDADO: +1 para ficar acima da bolinha

            previewContainer.addChild(sprite);
            layerSprites.set(i, sprite);
        } catch (e) {
            console.error(e);
        }
    }

    previewContainer.sortChildren();
}

async function saveGlobalConfig() {
    if (layers.length === 0 && currentVisualMode === 'global') {
        alert('Adicione pelo menos uma camada al√©m da bolinha base!');
        return;
    }

    try {
        let endpoint, body;
        
        if (currentVisualMode === 'item' && currentItemId) {
            // ‚úÖ Salvar para item espec√≠fico
            endpoint = `${API_URL}/api/admin/visual/save-item-config`;
            body = { itemId: currentItemId, layers };
        } else {
            // Salvar globalmente
            endpoint = `${API_URL}/api/admin/visual/save-global-layers`;
            body = { layers };
        }
        
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert('‚úÖ Configura√ß√£o salva com sucesso!');
        } else {
            alert('‚ùå Erro ao salvar');
        }
    } catch (e) {
        console.error(e);
        alert('‚ùå Erro de conex√£o');
    }
}

// INIT
window.addEventListener('DOMContentLoaded', loadItems);
</script>

</body>
</html>