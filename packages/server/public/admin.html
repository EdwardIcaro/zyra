<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZYRA Admin | Complete Dashboard</title>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root { 
        --bg: #0f0f0f; 
        --card: #1a1a1a; 
        --border: #333; 
        --accent: #007bff; 
        --text: #e0e0e0;  /* ‚úÖ NOVO: texto claro global */
        --text-muted: #999;  /* ‚úÖ NOVO: texto secund√°rio */
    }
    body { 
        background: var(--bg); 
        color: var(--text);  /* ‚úÖ MUDADO: era #e0e0e0 */
        font-family: 'Segoe UI', sans-serif; 
    }
    .navbar { 
        background: var(--card); 
        border-bottom: 1px solid var(--border); 
    }
    .nav-tabs { 
        border-bottom: 2px solid var(--border); 
    }
    .nav-link { 
        color: var(--text-muted);  /* ‚úÖ MUDADO */
        border: none !important; 
        margin-right: 10px; 
        transition: 0.3s; 
    }
    .nav-link:hover { 
        color: var(--text);  /* ‚úÖ MUDADO */
    }
    .nav-link.active { 
        color: var(--accent) !important; 
        background: transparent !important; 
        border-bottom: 2px solid var(--accent) !important; 
        font-weight: bold; 
    }
    .card { 
        background: var(--card); 
        border: 1px solid var(--border); 
        border-radius: 8px; 
    }
    .timeline { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding: 15px; 
        background: #252525; 
        border-radius: 8px; 
        min-height: 100px; 
    }
    .timeline-item { 
        background: #333; 
        border: 2px solid #555; 
        border-radius: 8px; 
        padding: 10px; 
        min-width: 120px; 
        cursor: move;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        color: var(--text);  /* ‚úÖ NOVO */
    }
    .timeline-item.active { 
        border-color: var(--accent); 
        background: #444; 
    }
    .preview-container { 
        background: #222; 
        border-radius: 8px; 
        padding: 20px; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 400px; 
    }
    
    /* ‚úÖ NOVOS estilos para labels e controles */
    label {
        color: var(--text);
        font-weight: 500;
    }
    
    .form-control, .form-select {
        background: #2a2a2a;
        border: 1px solid var(--border);
        color: var(--text);
    }
    
    .form-control:focus, .form-select:focus {
        background: #333;
        border-color: var(--accent);
        color: var(--text);
    }
    
    .text-muted {
        color: var(--text-muted) !important;
    }
</style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è ZYRA Admin Panel</span>
        <button class="btn btn-success btn-sm" onclick="applyChanges()">üîÑ Aplicar Mudan√ßas</button>
    </div>
</nav>

<div class="container-fluid px-4">
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link active" onclick="switchTab('items')">üì¶ Items</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" onclick="switchTab('monsters')">üëæ Monstros</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" onclick="switchTab('visual')">üé® Visual System</button>
        </li>
        <li class="nav-item">
        <button class="nav-link" onclick="switchTab('users')">üë• Usu√°rios</button>
        </li>
    </ul>

    <!-- ==================== USERS TAB ==================== -->
<div id="usersSection" style="display: none;">
    <div class="row">
        <!-- ========== COLUNA ESQUERDA: Busca e Lista ========== -->
        <div class="col-md-4">
            <div class="card p-4 mb-3">
                <h5 class="text-info mb-3">üîç Buscar Conta</h5>
                <input 
                    type="text" 
                    id="userSearchInput" 
                    class="form-control mb-2" 
                    placeholder="Nome da conta, personagem..."
                    onkeyup="handleUserSearch(event)"
                >
                <button class="btn btn-primary w-100" onclick="searchUsers()">
                    Buscar
                </button>
            </div>

            <div class="card p-0">
                <div class="card-header bg-dark text-light">
                    <strong>üìã Contas Encontradas</strong>
                </div>
                <div style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Chars</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    Use a busca acima
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== COLUNA DIREITA: Detalhes da Conta ========== -->
        <div class="col-md-8">
            <div id="userDetailsPanel" style="display: none;">
                
                <!-- Info da Conta -->
                <div class="card p-4 mb-3">
                    <h5 class="text-warning mb-3">üè¶ Informa√ß√µes da Conta</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Account ID</label>
                            <input type="text" id="acc_id" class="form-control mb-2" disabled>
                        </div>
                        <div class="col-md-6">
                            <label>Username</label>
                            <input type="text" id="acc_username" class="form-control mb-2" disabled>
                        </div>
                    </div>
                    <small class="text-muted">
                        Criado em: <span id="acc_created">-</span>
                    </small>
                </div>

                <!-- Lista de Personagens -->
                <div class="card p-4 mb-3">
                    <h5 class="text-success mb-3">üéÆ Personagens desta Conta</h5>
                    <div id="charactersListContainer">
                        <p class="text-muted">Carregando...</p>
                    </div>
                </div>

                <!-- Editor de Personagem -->
                <div id="characterEditorPanel" style="display: none;">
                    <div class="card p-4 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-primary mb-0">‚úèÔ∏è Editar Personagem</h5>
                            <button class="btn btn-sm btn-secondary" onclick="closeCharacterEditor()">
                                ‚Üê Voltar
                            </button>
                        </div>

                        <!-- Abas Internas: Dados | Invent√°rio -->
                        <ul class="nav nav-pills mb-3">
                            <li class="nav-item">
                                <button class="nav-link active" onclick="switchCharTab('data')" id="charTabData">
                                    üìä Dados
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" onclick="switchCharTab('inventory')" id="charTabInventory">
                                    üéí Invent√°rio
                                </button>
                            </li>
                        </ul>

                        <!-- Conte√∫do: Dados do Personagem -->
                        <div id="charDataSection">
                            <form id="characterEditForm">
                                <input type="hidden" id="char_id">
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Nome do Personagem</label>
                                        <input type="text" id="char_name" class="form-control mb-2" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Classe</label>
                                        <select id="char_class" class="form-select mb-2">
                                            <option value="warrior">Warrior</option>
                                            <option value="mage">Mage</option>
                                            <option value="archer">Archer</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Level</label>
                                        <input type="number" id="char_level" class="form-control mb-2" min="1" max="100">
                                    </div>
                                    <div class="col-md-4">
                                        <label>Experience</label>
                                        <input type="number" id="char_exp" class="form-control mb-2" min="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label>Gold</label>
                                        <input type="number" id="char_gold" class="form-control mb-2" min="0">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label>Max HP</label>
                                        <input type="number" id="char_maxHp" class="form-control mb-2">
                                    </div>
                                    <div class="col-md-4">
                                        <label>Damage</label>
                                        <input type="number" id="char_damage" class="form-control mb-2">
                                    </div>
                                    <div class="col-md-4">
                                        <label>Defense</label>
                                        <input type="number" id="char_defense" class="form-control mb-2">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Eye Type ID</label>
                                        <input type="number" id="char_eyeType" class="form-control mb-2" min="1">
                                    </div>
                                    <div class="col-md-6">
                                        <label>Body Color (Hex)</label>
                                        <input type="color" id="char_bodyColor" class="form-control mb-2">
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <small>
                                        <strong>Status:</strong> 
                                        <span id="char_status">Offline</span>
                                    </small>
                                </div>

                                <button type="submit" class="btn btn-success w-100">
                                    üíæ Salvar Altera√ß√µes
                                </button>
                            </form>
                        </div>

                        <!-- Conte√∫do: Invent√°rio -->
                        <div id="charInventorySection" style="display: none;">
                            <div class="d-flex justify-content-between mb-3">
                                <h6 class="text-muted">Itens Equipados e no Invent√°rio</h6>
                                <button class="btn btn-sm btn-primary" onclick="openAddItemModal()">
                                    ‚ûï Adicionar Item
                                </button>
                            </div>

                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Slot</th>
                                            <th>Item ID</th>
                                            <th>Qtd</th>
                                            <th>Equipado</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                Carregando invent√°rio...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder quando nenhuma conta est√° selecionada -->
            <div id="userDetailsPlaceholder">
                <div class="card p-5 text-center">
                    <div class="text-muted">
                        <i style="font-size: 64px;">üë§</i>
                        <h5 class="mt-3">Selecione uma conta para ver detalhes</h5>
                        <p>Use a busca √† esquerda para encontrar usu√°rios</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Adicionar Item -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">‚ûï Adicionar Item ao Invent√°rio</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <label>Item ID (Template)</label>
                    <input type="text" id="modal_itemId" class="form-control mb-2" placeholder="ex: sword_ink_blade" required>
                    
                    <label>Quantidade</label>
                    <input type="number" id="modal_quantity" class="form-control mb-2" value="1" min="1">
                    
                    <label>Slot Position (opcional)</label>
                    <input type="number" id="modal_slot" class="form-control mb-3" placeholder="0-39">
                    
                    <button type="submit" class="btn btn-primary w-100">Adicionar</button>
                </form>
            </div>
        </div>
    </div>
</div>

    <!-- ==================== ITEMS TAB ==================== -->
    <div id="itemsSection">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4">
                    <h5 class="text-primary mb-3">Editor de Item</h5>
                    <form id="itemForm">
                        <label>ID do Item</label>
                        <input type="text" id="i_id" class="form-control mb-2" required>
                        <label>Nome</label>
                        <input type="text" id="i_name" class="form-control mb-2" required>
                        <label>Tipo</label>
                        <label>Tipo</label>
                        <select id="i_type" class="form-select mb-2" onchange="toggleEquipableFields()">
                            <option value="material">Material</option>
                            <option value="weapon">Weapon</option>
                            <option value="armor">Armor</option>
                            <option value="accessory">Accessory</option>
                            <option value="consumable">Consumable</option>
                        </select>
                        <label>Grade</label>
                        <select id="i_grade" class="form-select mb-2">
                            <option value="">Nenhuma</option>
                            <option value="C">C</option>
                            <option value="B">B</option>
                            <option value="A">A</option>
                            <option value="S">S</option>
                        </select>

                        <!-- ‚úÖ NOVO: Campos de Equipamento -->
                        <div id="equipableFields" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="i_isEquipable" onchange="toggleSlotSelect()">
                                <label class="form-check-label" for="i_isEquipable">
                                    üìå Item Equip√°vel
                                </label>
                            </div>   

                        <div id="slotSelectContainer" style="display: none;">
                        <label>Slot de Equipamento</label>
                        <select id="i_equipSlot" class="form-select mb-2">
                            <option value="">Selecione...</option>
                            <option value="weapon">Weapon (M√£o)</option>
                            <option value="head">Head (Cabe√ßa)</option>
                            <option value="chest">Armor (Torso)</option>
                            <option value="legs">Legs (Pernas)</option>
                            <option value="boots">Boots (P√©s)</option>
                            <option value="ring1">Ring (Anel)</option>
                            <option value="amulet">Neck (Colar)</option>
                        </select>
                            </div>
                        </div>           

                        <label>Descri√ß√£o</label>
                        <textarea id="i_desc" class="form-control mb-3" rows="3"></textarea>
                        <button type="submit" class="btn btn-primary w-100">Salvar Item</button>
                    </form>
                </div>
            </div>

            <script>
            // ‚úÖ NOVO: Mostrar/ocultar campos de equipamento
            function toggleEquipableFields() {
                const type = document.getElementById('i_type').value;
                const equipableFields = document.getElementById('equipableFields');
                
                // Mostrar campos apenas para weapon, armor, accessory
                if (type === 'weapon' || type === 'armor' || type === 'accessory') {
                    equipableFields.style.display = 'block';
                    document.getElementById('i_isEquipable').checked = true;
                    toggleSlotSelect();
                } else {
                    equipableFields.style.display = 'none';
                    document.getElementById('i_isEquipable').checked = false;
                    document.getElementById('slotSelectContainer').style.display = 'none';
                }
            }

            function toggleSlotSelect() {
                const isEquipable = document.getElementById('i_isEquipable').checked;
                document.getElementById('slotSelectContainer').style.display = isEquipable ? 'block' : 'none';
            }

            // ‚úÖ ATUALIZAR submit do formul√°rio
            document.getElementById('itemForm').onsubmit = async (e) => {
                e.preventDefault();
                
                const isEquipable = document.getElementById('i_isEquipable').checked;
                const equipSlot = isEquipable ? document.getElementById('i_equipSlot').value : null;

                await fetch(`${API_URL}/api/admin/items/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id: document.getElementById('i_id').value,
                        name: document.getElementById('i_name').value,
                        description: document.getElementById('i_desc').value,
                        type: document.getElementById('i_type').value,
                        grade: document.getElementById('i_grade').value,
                        stackable: document.getElementById('i_type').value === 'material',
                        is_equipable: isEquipable,       // ‚úÖ NOVO
                        equip_slot: equipSlot,           // ‚úÖ NOVO
                        item_type: document.getElementById('i_type').value  // ‚úÖ NOVO
                    })
                });
                
                alert('‚úÖ Item salvo com sucesso!');
                loadItems();
            };

            // ‚úÖ ATUALIZAR editItem para preencher novos campos
            function editItem(id) {
                const i = window.cachedItems.find(x => x.id === id);
                if(!i) return;
                
                document.getElementById('i_id').value = i.id;
                document.getElementById('i_name').value = i.name;
                document.getElementById('i_desc').value = i.description || '';
                document.getElementById('i_type').value = i.item_type || i.type;
                document.getElementById('i_grade').value = i.grade || '';
                
                // ‚úÖ NOVO: Preencher campos de equipamento
                if (i.is_equipable) {
                    document.getElementById('equipableFields').style.display = 'block';
                    document.getElementById('i_isEquipable').checked = true;
                    document.getElementById('slotSelectContainer').style.display = 'block';
                    document.getElementById('i_equipSlot').value = i.equip_slot || '';
                }
                
                toggleEquipableFields();
            }
            </script>

            <div class="col-md-8">
                <div class="card p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>ID</th><th>Nome</th><th>Tipo</th><th>Grade</th></tr>
                        </thead>
                        <tbody id="itemsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MONSTERS TAB ==================== -->
    <div id="monstersSection" style="display: none;">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4">
                    <h5 class="text-warning mb-3">Editor de Monstro</h5>
                    <form id="monsterForm">
                        <label>ID</label>
                        <input type="text" id="m_id" class="form-control mb-2" required>
                        <label>Nome</label>
                        <input type="text" id="m_name" class="form-control mb-2" required>
                        <label>N√≠vel</label>
                        <input type="number" id="m_level" class="form-control mb-2" value="1">
                        <label>HP</label>
                        <input type="number" id="m_hp" class="form-control mb-2" value="50">
                        <label>Dano</label>
                        <input type="number" id="m_damage" class="form-control mb-2" value="5">
                        <label>Exp Base</label>
                        <input type="number" id="m_exp" class="form-control mb-3" value="10">
                        <button type="submit" class="btn btn-warning w-100">Salvar Monstro</button>
                    </form>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr><th>ID</th><th>Nome</th><th>N√≠vel</th><th>HP</th><th>A√ß√µes</th></tr>
                        </thead>
                        <tbody id="monstersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



 <!-- ==================== VISUAL SYSTEM TAB ==================== -->
<div id="visualSection" style="display: none;">
    <div class="row">
        <div class="col-md-4">
            
            <!-- ‚úÖ Seletor de Modo -->
            <div class="card p-4 mb-3">
                <h5 class="text-warning mb-3">üéØ Modo de Configura√ß√£o</h5>
                <label>Configurar para:</label>
                <select id="visualModeSelect" class="form-select mb-2" onchange="switchVisualMode()">
                    <option value="global">Config Global (Todos os Players)</option>
                    <option value="item">Item Espec√≠fico</option>
                </select>
                
                <!-- Container que aparece quando item for selecionado -->
                <div id="itemSelectorContainer" style="display: none;">
                    <label>Selecionar Item:</label>
                    <select id="visualItemSelect" class="form-select mb-2" onchange="loadItemVisualConfig()">
                        <option value="">Carregando...</option>
                    </select>
                    <small class="text-muted">Camadas ser√£o salvas para este item espec√≠fico</small>
                </div>
            </div>

            <!-- ‚úÖ Adicionar Camada -->
            <div class="card p-4 mb-3">
                <h5 class="text-info mb-3">üì¶ Adicionar Camada</h5>
                <label>Tipo</label>
                <select id="layerTypeSelect" class="form-select mb-2" onchange="loadAssetsForLayer()">
                    <option value="">Selecione...</option>
                    <option value="bodies">Corpos</option>
                    <option value="faces">Olhos</option>
                    <option value="hats">Chap√©us</option>
                </select>
                <label>Asset</label>
                <select id="assetSelect" class="form-select mb-3" disabled></select>
                <button class="btn btn-primary w-100" onclick="addLayerToTimeline()">‚ûï Adicionar</button>
            </div>

            <!-- ‚úÖ Ajustes da Camada -->
            <div class="card p-4">
                <h5 class="text-warning mb-3">‚öôÔ∏è Ajustes da Camada</h5>
                <div id="layerControls">
                    <p class="text-muted">Selecione uma camada</p>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <!-- ‚úÖ Timeline -->
            <div class="card p-3 mb-3">
                <h5>üé¨ Timeline de Camadas</h5>
                <div id="timeline" class="timeline">
                    <div class="text-muted" style="margin: auto;">Arraste assets aqui</div>
                </div>
            </div>

            <!-- ‚úÖ Preview -->
            <div class="card p-0">
                <div class="preview-container">
                    <div id="pixi-preview"></div>
                </div>
            </div>
            
            <!-- ‚úÖ Bot√£o Salvar -->
            <div class="text-center mt-3">
                <button class="btn btn-success" onclick="saveGlobalConfig()">üíæ Salvar Config Global</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = "http://localhost:2567";
const CLIENT_URL = "http://localhost:3000";

let pixiApp = null;
let previewContainer = null;
let layers = [];
let selectedLayerIndex = -1;
let layerSprites = new Map();

// ============================================
// TAB SWITCHING
// ============================================
function switchTab(tab) {
    document.querySelectorAll('[id$="Section"]').forEach(s => s.style.display = 'none');
    document.getElementById(tab + 'Section').style.display = 'block';
    
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    if (tab === 'items') loadItems();
    if (tab === 'monsters') loadMonsters();
    if (tab === 'visual') initPixi();
    if (tab === 'users') loadUsersTab(); // ‚úÖ NOVO: carregar aba de usu√°rios
}

// ============================================
// ITEMS LOGIC
// ============================================
async function loadItems() {
    const res = await fetch(`${API_URL}/api/admin/items`);
    const data = await res.json();
    document.getElementById('itemsTableBody').innerHTML = data.map(i => `
        <tr onclick="editItem('${i.id}')">
            <td>${i.id}</td><td>${i.name}</td><td>${i.type}</td><td>${i.grade || '-'}</td>
        </tr>
    `).join('');
    window.cachedItems = data;
}

document.getElementById('itemForm').onsubmit = async (e) => {
    e.preventDefault();
    await fetch(`${API_URL}/api/admin/items/save`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id: document.getElementById('i_id').value,
            name: document.getElementById('i_name').value,
            description: document.getElementById('i_desc').value,
            type: document.getElementById('i_type').value,
            grade: document.getElementById('i_grade').value,
            stackable: document.getElementById('i_type').value === 'material'
        })
    });
    alert('Item salvo!');
    loadItems();
};

function editItem(id) {
    const i = window.cachedItems.find(x => x.id === id);
    if(!i) return;
    document.getElementById('i_id').value = i.id;
    document.getElementById('i_name').value = i.name;
    document.getElementById('i_desc').value = i.description || '';
    document.getElementById('i_type').value = i.type;
    document.getElementById('i_grade').value = i.grade || '';
}

// ============================================
// MONSTERS LOGIC
// ============================================
async function loadMonsters() {
    const res = await fetch(`${API_URL}/api/admin/monsters`);
    const data = await res.json();
    document.getElementById('monstersTableBody').innerHTML = data.map(m => `
        <tr onclick="editMonster('${m.id}')">
            <td>${m.id}</td><td>${m.name}</td><td>${m.level}</td><td>${m.stats?.maxHp || 50}</td>
            <td><button class="btn btn-sm btn-warning">Editar</button></td>
        </tr>
    `).join('');
    window.cachedMonsters = data;
}

document.getElementById('monsterForm').onsubmit = async (e) => {
    e.preventDefault();
    await fetch(`${API_URL}/api/admin/monsters/save`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            id: document.getElementById('m_id').value,
            name: document.getElementById('m_name').value,
            level: parseInt(document.getElementById('m_level').value),
            stats: { 
                maxHp: parseInt(document.getElementById('m_hp').value),
                damage: parseInt(document.getElementById('m_damage').value)
            },
            rewards: { baseExp: parseInt(document.getElementById('m_exp').value) }
        })
    });
    alert('Monstro salvo!');
    loadMonsters();
};

function editMonster(id) {
    const m = window.cachedMonsters.find(x => x.id === id);
    if(!m) return;
    document.getElementById('m_id').value = m.id;
    document.getElementById('m_name').value = m.name;
    document.getElementById('m_level').value = m.level;
    document.getElementById('m_hp').value = m.stats?.maxHp || 50;
    document.getElementById('m_damage').value = m.stats?.damage || 5;
    document.getElementById('m_exp').value = m.rewards?.baseExp || 10;
}

async function applyChanges() {
    const res = await fetch(`${API_URL}/api/admin/reload`, { method: 'POST' });
    if(res.ok) alert('üöÄ Servidor sincronizado!');
}

let currentVisualMode = 'global';  // ‚úÖ NOVO: rastreia modo atual
let currentItemId = null;  // ‚úÖ NOVO: item selecionado
let baseBallSprite = null;  // ‚úÖ NOVO: refer√™ncia ao sprite base

// ‚úÖ NOVO: Alternar entre Global e Item
async function switchVisualMode() {
    currentVisualMode = document.getElementById('visualModeSelect').value;
    const itemContainer = document.getElementById('itemSelectorContainer');
    
    if (currentVisualMode === 'item') {
        itemContainer.style.display = 'block';
        await loadItemsForVisualConfig();
    } else {
        itemContainer.style.display = 'none';
        currentItemId = null;
        layers = [];
        renderTimeline();
        await renderPreview();
    }
    
    updateSaveButtonText();
}

// ‚úÖ NOVO: Carregar lista de itens
async function loadItemsForVisualConfig() {
    try {
        const res = await fetch(`${API_URL}/api/admin/items`);
        const items = await res.json();
        
        const select = document.getElementById('visualItemSelect');
        select.innerHTML = '<option value="">-- Selecione um Item --</option>' + 
            items.map(item => `<option value="${item.id}">${item.name} (${item.id})</option>`).join('');
    } catch (e) {
        console.error('[Visual] Erro ao carregar itens:', e);
    }
}

// ‚úÖ NOVO: Carregar config de um item
async function loadItemVisualConfig() {
    currentItemId = document.getElementById('visualItemSelect').value;
    
    if (!currentItemId) {
        layers = [];
        renderTimeline();
        await renderPreview();
        return;
    }
    
    try {
        const res = await fetch(`${API_URL}/api/admin/visual/item/${currentItemId}`);
        if (res.ok) {
            const data = await res.json();
            layers = data.layers || [];
            renderTimeline();
            await renderPreview();
        }
    } catch (e) {
        console.error('[Visual] Erro ao carregar config do item:', e);
        layers = [];
        renderTimeline();
        await renderPreview();
    }
}

// ‚úÖ NOVO: Atualizar texto do bot√£o
function updateSaveButtonText() {
    const btn = document.querySelector('button[onclick="saveGlobalConfig()"]');
    if (!btn) return;
    
    if (currentVisualMode === 'item' && currentItemId) {
        const itemName = document.getElementById('visualItemSelect').selectedOptions[0]?.text || 'Item';
        btn.textContent = `üíæ Salvar Config para ${itemName}`;
    } else {
        btn.textContent = 'üíæ Salvar Config Global';
    }
}

// ============================================
// VISUAL SYSTEM LOGIC
// ============================================
async function initPixi() {
    if (pixiApp) return;

    pixiApp = new PIXI.Application();
    await pixiApp.init({ width: 300, height: 300, backgroundColor: 0x222222 });
    
    document.getElementById('pixi-preview').innerHTML = '';
    document.getElementById('pixi-preview').appendChild(pixiApp.canvas);

    previewContainer = new PIXI.Container();
    previewContainer.x = 150;
    previewContainer.y = 150;
    pixiApp.stage.addChild(previewContainer);

    // ‚úÖ NOVO: Carregar bolinha base automaticamente
    await loadBaseBall();

    const highlight = new PIXI.Graphics();
    highlight.circle(0, 0, 30);
    highlight.stroke({ width: 2, color: 0xffff00, alpha: 0.5 });
    previewContainer.addChild(highlight);

    pixiApp.ticker.add(() => {
        const bounce = Math.sin(Date.now() / 200) * 0.04;
        previewContainer.scale.set(1 + bounce);
    });
}

// ‚úÖ NOVA FUN√á√ÉO: Carregar sprite base do corpo
async function loadBaseBall() {
    try {
        const path = `${CLIENT_URL}/assets/sprites/bodies/ball_red.png`;
        const texture = await PIXI.Assets.load(path);
        
        baseBallSprite = new PIXI.Sprite(texture);
        baseBallSprite.anchor.set(0.5);
        baseBallSprite.scale.set(1.0);  // Escala fixa
        baseBallSprite.zIndex = 0;  // Sempre na camada mais baixa
        
        previewContainer.addChild(baseBallSprite);
        previewContainer.sortChildren();
        
        console.log('[Visual] Bolinha base carregada automaticamente');
    } catch (e) {
        console.error('[Visual] Erro ao carregar bolinha:', e);
    }
}

async function loadAssetsForLayer() {
    const type = document.getElementById('layerTypeSelect').value;
    const select = document.getElementById('assetSelect');
    
    if (!type) {
        select.disabled = true;
        return;
    }

    try {
        const res = await fetch(`${API_URL}/api/admin/assets/${type}`);
        const files = await res.json();
        select.innerHTML = files.map(f => `<option value="${f.replace('.png', '')}">${f}</option>`).join('');
        select.disabled = false;
    } catch (e) {
        console.error(e);
    }
}

function addLayerToTimeline() {
    const type = document.getElementById('layerTypeSelect').value;
    const asset = document.getElementById('assetSelect').value;
    
    if (!type || !asset) {
        alert('Selecione tipo e asset!');
        return;
    }

    const defaults = {
        bodies: { offsetX: 0, offsetY: 0, scale: 1.0, rotation: 0, width: 58, height: 58 },
        faces: { offsetX: 0, offsetY: 5, scale: 1.0, rotation: 0, width: 35, height: 18 },
        hats: { offsetX: 0, offsetY: -20, scale: 1.0, rotation: 0, width: 60, height: 45 }
    };

    layers.push({
        type,
        asset,
        ...defaults[type],
        zIndex: layers.length
    });

    renderTimeline();
    renderPreview();
}

function renderTimeline() {
    const timeline = document.getElementById('timeline');
    
    if (layers.length === 0) {
        timeline.innerHTML = '<div class="text-muted" style="margin: auto;">Arraste assets aqui</div>';
        return;
    }

    timeline.innerHTML = layers.map((layer, idx) => `
        <div class="timeline-item ${idx === selectedLayerIndex ? 'active' : ''}" 
             onclick="selectLayer(${idx})">
            <div>${layer.asset}</div>
            <button class="btn btn-sm btn-danger" onclick="removeLayer(${idx}); event.stopPropagation();">üóëÔ∏è</button>
        </div>
    `).join('');
}

function selectLayer(index) {
    selectedLayerIndex = index;
    renderTimeline();
    showLayerControls(layers[index]);
}

function removeLayer(index) {
    layers.splice(index, 1);
    selectedLayerIndex = -1;
    renderTimeline();
    renderPreview();
    document.getElementById('layerControls').innerHTML = '<p class="text-muted">Selecione uma camada</p>';
}

function showLayerControls(layer) {
    const controls = document.getElementById('layerControls');
    
    controls.innerHTML = `
        <strong>${layer.asset}</strong>

        <label>Offset X: <span id="val_offsetX">${layer.offsetX}</span></label>
        <input type="range" class="form-range" id="range_offsetX" min="-100" max="100" value="${layer.offsetX}" oninput="updateLayerProp('offsetX', this.value)">

        <label>Offset Y: <span id="val_offsetY">${layer.offsetY}</span></label>
        <input type="range" class="form-range" id="range_offsetY" min="-100" max="100" value="${layer.offsetY}" oninput="updateLayerProp('offsetY', this.value)">

        <label>Escala: <span id="val_scale">${layer.scale.toFixed(2)}</span></label>
        <input type="range" class="form-range" id="range_scale" min="0.1" max="3.0" step="0.05" value="${layer.scale}" oninput="updateLayerProp('scale', this.value)">

        <label>Rota√ß√£o: <span id="val_rotation">${layer.rotation}¬∞</span></label>
        <input type="range" class="form-range" id="range_rotation" min="-180" max="180" step="5" value="${layer.rotation}" oninput="updateLayerProp('rotation', this.value)">
    `;
}

function updateLayerProp(prop, value) {
    if (selectedLayerIndex === -1) return;

    const numValue = parseFloat(value);
    layers[selectedLayerIndex][prop] = numValue;

    const displayElement = document.getElementById(`val_${prop}`);
    if (displayElement) {
        displayElement.innerText = prop === 'scale' ? numValue.toFixed(2) : Math.round(numValue);
    }
    
    renderPreview();
}

async function renderPreview() {
    if (!pixiApp || !previewContainer) await initPixi();

    // ‚úÖ MUDADO: Remover apenas sprites de camadas, n√£o a bolinha base
    layerSprites.forEach(sprite => {
        if (sprite !== baseBallSprite) {  // Preservar bolinha
            previewContainer.removeChild(sprite);
            sprite.destroy();
        }
    });
    layerSprites.clear();
    
    // ‚úÖ NOVO: Re-adicionar bolinha se foi removida acidentalmente
    if (baseBallSprite && !previewContainer.children.includes(baseBallSprite)) {
        previewContainer.addChildAt(baseBallSprite, 0);
    }

    for (let i = 0; i < layers.length; i++) {
        const layer = layers[i];
        const path = `${CLIENT_URL}/assets/sprites/${layer.type}/${layer.asset}.png`;

        try {
            const texture = await PIXI.Assets.load(path);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = layer.offsetX;
            sprite.y = layer.offsetY;
            sprite.scale.set(layer.scale);
            sprite.rotation = (layer.rotation * Math.PI) / 180;
            sprite.zIndex = i + 1;  // ‚úÖ MUDADO: +1 para ficar acima da bolinha

            previewContainer.addChild(sprite);
            layerSprites.set(i, sprite);
        } catch (e) {
            console.error(e);
        }
    }

    previewContainer.sortChildren();
}

async function saveGlobalConfig() {
    if (layers.length === 0 && currentVisualMode === 'global') {
        alert('Adicione pelo menos uma camada al√©m da bolinha base!');
        return;
    }

    try {
        let endpoint, body;
        
        if (currentVisualMode === 'item' && currentItemId) {
            // ‚úÖ Salvar para item espec√≠fico
            endpoint = `${API_URL}/api/admin/visual/save-item-config`;
            body = { itemId: currentItemId, layers };
        } else {
            // Salvar globalmente
            endpoint = `${API_URL}/api/admin/visual/save-global-layers`;
            body = { layers };
        }
        
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert('‚úÖ Configura√ß√£o salva com sucesso!');
        } else {
            alert('‚ùå Erro ao salvar');
        }
    } catch (e) {
        console.error(e);
        alert('‚ùå Erro de conex√£o');
    }
}

// INIT
window.addEventListener('DOMContentLoaded', loadItems);

// ============================================
// USERS TAB - LOGIC
// ============================================


let currentAccountId = null;
let currentCharacterId = null;

function loadUsersTab() {
    console.log('[Users] Tab carregada');
    // Limpar estado
    currentAccountId = null;
    currentCharacterId = null;
    document.getElementById('userDetailsPanel').style.display = 'none';
    document.getElementById('userDetailsPlaceholder').style.display = 'block';
}

// Enter para buscar
function handleUserSearch(event) {
    if (event.key === 'Enter') {
        searchUsers();
    }
}

// Buscar usu√°rios
async function searchUsers() {
    const query = document.getElementById('userSearchInput').value.trim();
    
    if (!query) {
        alert('Digite algo para buscar');
        return;
    }

    try {
        const res = await fetch(`${API_URL}/api/admin/users?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        const tbody = document.getElementById('usersTableBody');
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhum resultado</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(acc => `
            <tr onclick="loadAccountDetails(${acc.id})" style="cursor: pointer;">
                <td>${acc.id}</td>
                <td>${acc.username}</td>
                <td><span class="badge bg-info">${acc._count?.characters || 0}</span></td>
            </tr>
        `).join('');
        
        window.cachedAccounts = data;
    } catch (e) {
        console.error('[Users] Erro ao buscar:', e);
        alert('Erro ao buscar usu√°rios');
    }
}

// Carregar detalhes da conta
async function loadAccountDetails(accountId) {
    currentAccountId = accountId;
    
    try {
        const res = await fetch(`${API_URL}/api/admin/user/${accountId}`);
        const data = await res.json();
        
        // Preencher dados da conta
        document.getElementById('acc_id').value = data.id;
        document.getElementById('acc_username').value = data.username;
        document.getElementById('acc_created').textContent = new Date(data.createdAt).toLocaleString('pt-BR');
        
        // Listar personagens
        const charContainer = document.getElementById('charactersListContainer');
        
        if (data.characters.length === 0) {
            charContainer.innerHTML = '<p class="text-muted">Nenhum personagem criado</p>';
        } else {
            charContainer.innerHTML = data.characters.map(char => `
                <div class="card mb-2" style="background: #2a2a2a; cursor: pointer;" onclick="loadCharacterEditor(${char.id})">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${char.char_name}</strong>
                                <span class="badge bg-secondary ms-2">${char.class_type}</span>
                            </div>
                            <div>
                                <span class="badge bg-warning">Lv ${char.level}</span>
                                <span class="badge bg-success">${char.gold}g</span>
                            </div>
                        </div>
                        <small class="text-muted">
                            HP: ${char.max_hp || 100} | DMG: ${char.damage || 10} | Exp: ${char.experience || 0}
                        </small>
                    </div>
                </div>
            `).join('');
        }
        
        // Mostrar painel
        document.getElementById('userDetailsPlaceholder').style.display = 'none';
        document.getElementById('userDetailsPanel').style.display = 'block';
        document.getElementById('characterEditorPanel').style.display = 'none';
        
        window.cachedCharacters = data.characters;
    } catch (e) {
        console.error('[Users] Erro ao carregar conta:', e);
        alert('Erro ao carregar detalhes da conta');
    }
}

// Carregar editor de personagem
async function loadCharacterEditor(charId) {
    currentCharacterId = charId;
    
    try {
        const res = await fetch(`${API_URL}/api/admin/character/${charId}`);
        const char = await res.json();
        
        // Preencher formul√°rio
        document.getElementById('char_id').value = char.id;
        document.getElementById('char_name').value = char.char_name;
        document.getElementById('char_class').value = char.class_type;
        document.getElementById('char_level').value = char.level;
        document.getElementById('char_exp').value = char.experience || 0;
        document.getElementById('char_gold').value = char.gold || 0;
        document.getElementById('char_maxHp').value = char.max_hp || 100;
        document.getElementById('char_damage').value = char.damage || 10;
        document.getElementById('char_defense').value = char.defense || 0;
        document.getElementById('char_eyeType').value = char.eye_type_id || 1;
        document.getElementById('char_bodyColor').value = char.body_color || '#FF6B6B';
        
        // Status online/offline
        const status = char.session_id ? 'Online üü¢' : 'Offline üî¥';
        document.getElementById('char_status').textContent = status;
        
        // Mostrar editor
        document.getElementById('characterEditorPanel').style.display = 'block';
        switchCharTab('data');
        
        // Carregar invent√°rio
        loadCharacterInventory(charId);
        
        window.currentCharacterData = char;
    } catch (e) {
        console.error('[Users] Erro ao carregar personagem:', e);
        alert('Erro ao carregar personagem');
    }
}

// Fechar editor
function closeCharacterEditor() {
    document.getElementById('characterEditorPanel').style.display = 'none';
    currentCharacterId = null;
}

// Alternar abas internas (Dados | Invent√°rio)
function switchCharTab(tab) {
    document.getElementById('charDataSection').style.display = tab === 'data' ? 'block' : 'none';
    document.getElementById('charInventorySection').style.display = tab === 'inventory' ? 'block' : 'none';
    
    document.getElementById('charTabData').classList.toggle('active', tab === 'data');
    document.getElementById('charTabInventory').classList.toggle('active', tab === 'inventory');
}

// Salvar altera√ß√µes do personagem
document.getElementById('characterEditForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const charId = document.getElementById('char_id').value;
    
    const updates = {
        char_name: document.getElementById('char_name').value,
        class_type: document.getElementById('char_class').value,
        level: parseInt(document.getElementById('char_level').value),
        experience: parseInt(document.getElementById('char_exp').value),
        gold: parseInt(document.getElementById('char_gold').value),
        max_hp: parseInt(document.getElementById('char_maxHp').value),
        damage: parseInt(document.getElementById('char_damage').value),
        defense: parseInt(document.getElementById('char_defense').value),
        eye_type_id: parseInt(document.getElementById('char_eyeType').value),
        body_color: document.getElementById('char_bodyColor').value
    };
    
    try {
        const res = await fetch(`${API_URL}/api/admin/character/${charId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (res.ok) {
            alert('‚úÖ Personagem atualizado com sucesso!');
            loadAccountDetails(currentAccountId); // Recarregar lista
        } else {
            alert('‚ùå Erro ao salvar');
        }
    } catch (e) {
        console.error('[Users] Erro ao salvar:', e);
        alert('‚ùå Erro de conex√£o');
    }
};

// Carregar invent√°rio
async function loadCharacterInventory(charId) {
    try {
        const res = await fetch(`${API_URL}/api/admin/character/${charId}/inventory`);
        const items = await res.json();
        
        const tbody = document.getElementById('inventoryTableBody');
        
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Invent√°rio vazio</td></tr>';
            return;
        }
        
        tbody.innerHTML = items.map(item => `
            <tr>
                <td>${item.slot_position}</td>
                <td><code>${item.item_id}</code></td>
                <td>${item.quantity}</td>
                <td>${item.is_equipped ? '‚úÖ' : '‚ùå'}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
        
        window.cachedInventory = items;
    } catch (e) {
        console.error('[Users] Erro ao carregar invent√°rio:', e);
    }
}

// Abrir modal de adicionar item
function openAddItemModal() {
    const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
    modal.show();
}

// Adicionar item
document.getElementById('addItemForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const itemId = document.getElementById('modal_itemId').value;
    const quantity = parseInt(document.getElementById('modal_quantity').value);
    const slot = document.getElementById('modal_slot').value;
    
    try {
        const res = await fetch(`${API_URL}/api/admin/character/${currentCharacterId}/item`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                itemId,
                quantity,
                slotPosition: slot ? parseInt(slot) : null
            })
        });
        
        if (res.ok) {
            alert('‚úÖ Item adicionado!');
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            loadCharacterInventory(currentCharacterId);
        } else {
            alert('‚ùå Erro ao adicionar item');
        }
    } catch (e) {
        console.error('[Users] Erro:', e);
        alert('‚ùå Erro de conex√£o');
    }
};

// Editar item (simplificado)
function editItem(itemId) {
    const item = window.cachedInventory.find(i => i.id === itemId);
    if (!item) return;
    
    const newQty = prompt('Nova quantidade:', item.quantity);
    if (!newQty) return;
    
    updateItemQuantity(itemId, parseInt(newQty));
}

async function updateItemQuantity(itemId, quantity) {
    try {
        const res = await fetch(`${API_URL}/api/admin/item/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity })
        });
        
        if (res.ok) {
            alert('‚úÖ Atualizado!');
            loadCharacterInventory(currentCharacterId);
        }
    } catch (e) {
        console.error(e);
    }
}

// Deletar item
async function deleteItem(itemId) {
    if (!confirm('Tem certeza que deseja remover este item?')) return;
    
    try {
        const res = await fetch(`${API_URL}/api/admin/item/${itemId}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            alert('‚úÖ Item removido!');
            loadCharacterInventory(currentCharacterId);
        }
    } catch (e) {
        console.error(e);
    }
}
</script>

</body>
</html>